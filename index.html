<!DOCTYPE html>
    <html>
        <head>
            <meta charset="utf-8"/>
            <title></title>
            <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css" crossorigin=""/>
            <style type="text/css">
                #mapid { 
                    height: 750px; 
                }
            </style>
            <script src="js/custom.js" crossorigin=""></script>
        </head>
        <body>
        <div id="mapid"></div>
        <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js" crossorigin=""></script>
        <script type="text/javascript">
            var mymap = L.map('mapid').setView([-37.833988, 144.958119], 8);
            L.tileLayer('https://a.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
                maxZoom: 18,
            }).addTo(mymap);

            // Add default marker
            var mel = L.marker([-37.833988, 144.958119]).addTo(mymap).bindPopup('Melbourne')

            // Add marker on click
            var marker = L.marker();
                function onMapClick(e) {
                    marker
                        .setLatLng(e.latlng)
                        .addTo(mymap)
                        .bindPopup("You clicked the map at " + e.latlng.toString())
                    var dist = distance(-37.833988, 144.958119, e.latlng.lat, e.latlng.lng, 'K');
                    console.log(dist);
                }
            mymap.on('click', onMapClick);

            // Create JSON data
            var data = 
                [
                    { 
                        "employee_postcode": 3000, 
                        "postcode_latitude": -37.8114,
                        "postcode_longitude": 144.965,      
                        "count": 37 
                    },
                    { 
                        "employee_postcode": 3752, 
                        "postcode_latitude": -37.6373,
                        "postcode_longitude": 145.086,      
                        "count": 17
                    },
                    { 
                        "employee_postcode": 3840, 
                        "postcode_latitude": -38.2601,
                        "postcode_longitude": 145.397,      
                        "count": 1
                    },
                    { 
                        "employee_postcode": 3984, 
                        "postcode_latitude": -38.3357,
                        "postcode_longitude": 145.567,      
                        "count": 1
                    }
                ]

            // Convert JSON to geoJSON
            var jsonFeatures = []

                data.forEach(function(point){
                var lat = point.postcode_latitude;
                var lon = point.postcode_longitude;

                var feature = {
                    type: 'Feature',
                    properties: {
                        postcode: point.employee_postcode, 
                        count: point.count
                    },
                    geometry: {
                        type: 'Point',
                        coordinates: [lon,lat]
                    }
                };

                jsonFeatures.push(feature);
            });

            // Function for accessing geoJSON features
            var distances = [];
            var counts = []; 
            function getFeatures(feature, layer) {
                // Convert to string for popup
                var pcodeStr = feature.properties.postcode.toString();
                var cntStr = feature.properties.count.toString();
                // Get latlngs for distance calc
                var lat = feature.geometry.coordinates[1];
                var lng = feature.geometry.coordinates[0];
                var dist = distance(-37.833988, 144.958119, lat, lng, 'K');
                // Create popup
                layer.bindPopup("Postcode: " + pcodeStr + ", Count: " + cntStr + ", Distance: " + dist);
                // Push weighted distances to array
                var distCount = dist * feature.properties.count;
                distances.push(distCount);         
                // Push counts to array       
                counts.push(feature.properties.count);
            };

            // Add geoJSON points to map
            L.geoJSON(jsonFeatures, {
                onEachFeature: getFeatures
            }).addTo(mymap);

            // Sum distances array 
            var sumDistances = sumArray(distances);

            // Sum counts array
            var sumCounts = sumArray(counts);

            // Average distance calc
            var avgDistance = sumDistances / sumCounts;
            console.log(avgDistance);
        </script>
    </body>
</html>

